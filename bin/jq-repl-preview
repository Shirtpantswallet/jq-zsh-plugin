#!/usr/bin/env zsh
JQ_REPL_JQ="${JQ_REPL_JQ:-jq}"
[[ $(print -rl -- ${(t)JQ_REPL_JQ}) =~ scalar* ]] && export JQ_REPL_JQ=( ${=JQ_REPL_JQ} )

query=$1
input_file=$2
last_success_file=$3
error_file="${last_success_file}.err"

# Run jq query, capture stdout and stderr separately
# JQ_REPL_ARGS has to be unquoted so it's passed as cli args to jq
# shellcheck disable=SC2086
if output=$($JQ_REPL_JQ[@] --color-output ${JQ_REPL_ARGS:-} "$query" "$input_file" 2>"$error_file"); then
  # Success: display output and cache it, clear error
  echo "$output"
  echo "$output" > "$last_success_file"
  : > "$error_file"
else
  # Failure: show last successful output (current is displayed in header via error_file)
  if [[ -f "$last_success_file" && -s "$last_success_file" ]]; then
    cat "$last_success_file"
  fi
fi
